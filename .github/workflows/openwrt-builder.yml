# ==============================================================================
# OpenWrt 构建工作流 (AX6000 定制版)
# 基于 P3TERX 的 Actions-OpenWrt 修改
# ==============================================================================

name: Build Xiaomi AX6000 (Hanwckf 21.02)

# 触发器配置
on:
  repository_dispatch:
  workflow_dispatch: # 手动触发按钮
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

# 环境变量设置
env:
  # 注意：这里使用的是 hanwckf 的源码 (21.02版本，闭源驱动，极度稳定)
  # 如果你想要 24.10，需要改回 https://github.com/immortalwrt/immortalwrt 和 master 分支
  REPO_URL: https://github.com/hanwckf/immortalwrt-mt798x
  REPO_BRANCH: openwrt-21.02
  FEEDS_CONF: feeds.conf.default
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # 1. 检出当前仓库代码
    - name: Checkout
      uses: actions/checkout@v4

    # 2. 初始化编译环境
    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # 清理旧的依赖和 Docker 释放空间
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        
        # 安装编译依赖
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
        
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"

    # 3. 克隆源码 (已修复路径问题，直接克隆到工作区)
    - name: Clone source code
      run: |
        df -hT $PWD
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        # 记录当前源码版本，方便排查
        cd openwrt && git log -1

    # 4. 加载自定义 Feeds (插件源)
    - name: Load custom feeds
      run: |
        cd openwrt
        # 添加 kenzok8 源以支持 Passwall/HomeProxy
        # echo "src-git kenzo https://github.com/kenzok8/small-package" >> feeds.conf.default
        
        # 如果仓库里有 diy-part1.sh 就执行，没有就跳过
        if [ -f $GITHUB_WORKSPACE/diy-part1.sh ]; then
          chmod +x $GITHUB_WORKSPACE/diy-part1.sh
          /bin/bash $GITHUB_WORKSPACE/diy-part1.sh
        fi

    # 5. 更新并安装插件
    - name: Update feeds
      run: cd openwrt && ./scripts/feeds update -a

    - name: Install feeds
      run: cd openwrt && ./scripts/feeds install -a

    # 6. 生成配置文件 (核心步骤：自动生成 .config)
    # 这里替代了上传 .config 文件的做法，更加自动化
    - name: Generate configuration file
      run: |
        cd openwrt
        
        # === 针对 Hanwckf 源码的 AX6000 配置 ===
        # 注意：Hanwckf 的 target 名称可能与官方不同，通常是 mt798x
        echo "CONFIG_TARGET_mediatek=y" >> .config" >> .config
        echo "CONFIG_TARGET_mediatek_mt7986=y" >> .config
        echo "CONFIG_TARGET_MULTI_PROFILE=y" >> .config
        echo "CONFIG_TARGET_DEVICE_mediatek_mt7986_DEVICE_xiaomi_redmi-router-ax6000=y" >> .config
        echo "CONFIG_TARGET_DEVICE_PACKAGES_mediatek_mt7986_DEVICE_xiaomi_redmi-router-ax6000=""" >> .config
        echo "CONFIG_TARGET_DEVICE_mediatek_mt7986_DEVICE_xiaomi_redmi-router-ax6000-stock=y" >> .config
        echo "CONFIG_TARGET_DEVICE_PACKAGES_mediatek_mt7986_DEVICE_xiaomi_redmi-router-ax6000-stock=""" >> .config
        echo "CONFIG_DEVEL=y" >> .config
        echo "CONFIG_TOOLCHAINOPTS=y" >> .config
        echo "CONFIG_BUSYBOX_CUSTOM=y" >> .config
        echo "CONFIG_TARGET_PER_DEVICE_ROOTFS=y" >> .config
        echo "CONFIG_AFALG_UPDATE_CTR_IV=y" >> .config
        echo "CONFIG_BUSYBOX_CONFIG_BLKID=y" >> .config
        echo "CONFIG_BUSYBOX_CONFIG_FEATURE_BLKID_TYPE=y" >> .config
        echo "CONFIG_BUSYBOX_CONFIG_VOLUMEID=y" >> .config
        echo "CONFIG_CONNINFRA_AUTO_UP=y" >> .config
        echo "CONFIG_CONNINFRA_EMI_SUPPORT=y" >> .config
        echo "CONFIG_INCLUDE_CONFIG=y" >> .config
        echo "CONFIG_JSON_OVERVIEW_IMAGE_INFO=y" >> .config
        echo "CONFIG_KERNEL_CGROUP_DEVICE=y" >> .config
        echo "CONFIG_KERNEL_CGROUP_FREEZER=y" >> .config
        echo "CONFIG_KERNEL_DEVMEM=y" >> .config
        echo "CONFIG_KERNEL_NET_CLS_CGROUP=y" >> .config
        echo "CONFIG_MTK_ACK_CTS_TIMEOUT_SUPPORT=y" >> .config
        echo "CONFIG_MTK_AIR_MONITOR=y" >> .config
        echo "CONFIG_MTK_AMPDU_CONF_SUPPORT=y" >> .config
        echo "CONFIG_MTK_ANTENNA_CONTROL_SUPPORT=y" >> .config
        echo "CONFIG_MTK_APCLI_SUPPORT=y" >> .config
        echo "CONFIG_MTK_ATE_SUPPORT=y" >> .config
        echo "CONFIG_MTK_BACKGROUND_SCAN_SUPPORT=y" >> .config
        echo "CONFIG_MTK_CAL_BIN_FILE_SUPPORT=y" >> .config
        echo "CONFIG_MTK_CFG_SUPPORT_FALCON_MURU=y" >> .config
        echo "CONFIG_MTK_CFG_SUPPORT_FALCON_PP=y" >> .config
        echo "CONFIG_MTK_CFG_SUPPORT_FALCON_SR=y" >> .config
        echo "CONFIG_MTK_CFG_SUPPORT_FALCON_TXCMD_DBG=y" >> .config
        echo "CONFIG_MTK_CHIP_MT7986=y" >> .config
        echo "CONFIG_MTK_CONNINFRA_APSOC=y" >> .config
        echo "CONFIG_MTK_CONNINFRA_APSOC_MT7986=y" >> .config
        echo "CONFIG_MTK_CON_WPS_SUPPORT=y" >> .config
        echo "CONFIG_MTK_DBDC_MODE=y" >> .config
        echo "CONFIG_MTK_DOT11K_RRM_SUPPORT=y" >> .config
        echo "CONFIG_MTK_DOT11R_FT_SUPPORT=y" >> .config
        echo "CONFIG_MTK_DOT11W_PMF_SUPPORT=y" >> .config
        echo "CONFIG_MTK_DOT11_HE_AX=y" >> .config
        echo "CONFIG_MTK_DOT11_N_SUPPORT=y" >> .config
        echo "CONFIG_MTK_DOT11_VHT_AC=y" >> .config
        echo "CONFIG_MTK_FAST_NAT_SUPPORT=y" >> .config
        echo "CONFIG_MTK_FIRST_IF_EEPROM_FLASH=y" >> .config
        echo "CONFIG_MTK_FIRST_IF_IPAILNA=y" >> .config
        echo "CONFIG_MTK_FIRST_IF_MT7986=y" >> .config
        echo "CONFIG_MTK_GREENAP_SUPPORT=y" >> .config
        echo "CONFIG_MTK_G_BAND_256QAM_SUPPORT=y" >> .config
        echo "CONFIG_MTK_HDR_TRANS_RX_SUPPORT=y" >> .config
        echo "CONFIG_MTK_HDR_TRANS_TX_SUPPORT=y" >> .config
        echo "CONFIG_MTK_ICAP_SUPPORT=y" >> .config
        echo "CONFIG_MTK_IGMP_SNOOP_SUPPORT=y" >> .config
        echo "CONFIG_MTK_INTERWORKING=y" >> .config
        echo "CONFIG_MTK_MAP_R2_VER_SUPPORT=y" >> .config
        echo "CONFIG_MTK_MAP_R3_VER_SUPPORT=y" >> .config
        echo "CONFIG_MTK_MAP_SUPPORT=y" >> .config
        echo "CONFIG_MTK_MBSS_DTIM_SUPPORT=y" >> .config
        echo "CONFIG_MTK_MBSS_SUPPORT=y" >> .config
        echo "CONFIG_MTK_MCAST_RATE_SPECIFIC=y" >> .config
        echo "CONFIG_MTK_MGMT_TXPWR_CTRL=y" >> .config
        echo "CONFIG_MTK_MLME_MULTI_QUEUE_SUPPORT=y" >> .config
        echo "CONFIG_MTK_MT_AP_SUPPORT=m" >> .config
        echo "CONFIG_MTK_MT_DFS_SUPPORT=y" >> .config
        echo "CONFIG_MTK_MT_MAC=y" >> .config
        echo "CONFIG_MTK_MT_WIFI=m" >> .config
        echo "CONFIG_MTK_MT_WIFI_DRIVER_VERSION_7672=y" >> .config
        echo "CONFIG_MTK_MT_WIFI_FIRMWARE_PATH_MT7986="mt7986-fw-20240823"" >> .config
        echo "CONFIG_MTK_MT_WIFI_MT7986_20240823=y" >> .config
        echo "CONFIG_MTK_MT_WIFI_PATH="mt_wifi"" >> .config
        echo "CONFIG_MTK_MUMIMO_SUPPORT=y" >> .config
        echo "CONFIG_MTK_MU_RA_SUPPORT=y" >> .config
        echo "CONFIG_MTK_OFFCHANNEL_SCAN_FEATURE=y" >> .config
        echo "CONFIG_MTK_OWE_SUPPORT=y" >> .config
        echo "CONFIG_MTK_PHY_ICS_SUPPORT=y" >> .config
        echo "CONFIG_MTK_QOS_R1_SUPPORT=y" >> .config
        echo "CONFIG_MTK_RA_PHY_RATE_SUPPORT=y" >> .config
        echo "CONFIG_MTK_RED_SUPPORT=y" >> .config
        echo "CONFIG_MTK_RTMP_FLASH_SUPPORT=y" >> .config
        echo "CONFIG_MTK_RT_FIRST_CARD_EEPROM="flash"" >> .config
        echo "CONFIG_MTK_RT_FIRST_IF_RF_OFFSET=0xc0000" >> .config
        echo "CONFIG_MTK_SCS_FW_OFFLOAD=y" >> .config
        echo "CONFIG_MTK_SECOND_IF_NONE=y" >> .config
        echo "CONFIG_MTK_SMART_CARRIER_SENSE_SUPPORT=y" >> .config
        echo "CONFIG_MTK_SPECTRUM_SUPPORT=y" >> .config
        echo "CONFIG_MTK_SUPPORT_OPENWRT=y" >> .config
        echo "CONFIG_MTK_THERMAL_PROTECT_SUPPORT=y" >> .config
        echo "CONFIG_MTK_THIRD_IF_NONE=y" >> .config
        echo "CONFIG_MTK_TPC_SUPPORT=y" >> .config
        echo "CONFIG_MTK_TXBF_SUPPORT=y" >> .config
        echo "CONFIG_MTK_UAPSD=y" >> .config
        echo "CONFIG_MTK_VLAN_SUPPORT=y" >> .config
        echo "CONFIG_MTK_VOW_SUPPORT=y" >> .config
        echo "CONFIG_MTK_WARP_V2=y" >> .config
        echo "CONFIG_MTK_WDS_SUPPORT=y" >> .config
        echo "CONFIG_MTK_WHNAT_SUPPORT=m" >> .config
        echo "CONFIG_MTK_WIFI_ADIE_TYPE="mt7976"" >> .config
        echo "CONFIG_MTK_WIFI_BASIC_FUNC=y" >> .config
        echo "CONFIG_MTK_WIFI_DRIVER=y" >> .config
        echo "CONFIG_MTK_WIFI_EAP_FEATURE=y" >> .config
        echo "CONFIG_MTK_WIFI_FW_BIN_LOAD=y" >> .config
        echo "CONFIG_MTK_WIFI_MODE_AP=m" >> .config
        echo "CONFIG_MTK_WIFI_MT_MAC=y" >> .config
        echo "CONFIG_MTK_WIFI_SKU_TYPE="AX6000"" >> .config
        echo "CONFIG_MTK_WIFI_TWT_SUPPORT=y" >> .config
        echo "CONFIG_MTK_WLAN_HOOK=y" >> .config
        echo "CONFIG_MTK_WLAN_SERVICE=y" >> .config
        echo "CONFIG_MTK_WNM_SUPPORT=y" >> .config
        echo "CONFIG_MTK_WPA3_SUPPORT=y" >> .config
        echo "CONFIG_MTK_WSC_INCLUDED=y" >> .config
        echo "CONFIG_MTK_WSC_V2_SUPPORT=y" >> .config
        echo "CONFIG_OPENSSL_WITH_NPN=y" >> .config
        echo "CONFIG_PACKAGE_TURBOACC_INCLUDE_NO_FASTPATH=y" >> .config
        echo "CONFIG_PACKAGE_blockd=y" >> .config
        echo "CONFIG_PACKAGE_ca-certificates=y" >> .config
        echo "CONFIG_PACKAGE_datconf=y" >> .config
        echo "CONFIG_PACKAGE_datconf-lua=y" >> .config
        echo "CONFIG_PACKAGE_ebtables=y" >> .config
        echo "CONFIG_PACKAGE_ethtool=y" >> .config
        echo "CONFIG_PACKAGE_htop=y" >> .config
        echo "CONFIG_PACKAGE_ip-bridge=y" >> .config
        echo "CONFIG_PACKAGE_ip6tables-extra=y" >> .config
        echo "CONFIG_PACKAGE_ipset=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-conntrack-extra=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-extra=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-filter=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-hashlimit=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-iface=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-ipmark=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-ipopt=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-iprange=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-ipv4options=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-nat-extra=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-proto=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-tee=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-tproxy=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-u32=y" >> .config
        echo "CONFIG_PACKAGE_iw=y" >> .config
        echo "CONFIG_PACKAGE_iwinfo=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ata-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-conninfra=y" >> .config
        echo "CONFIG_PACKAGE_kmod-crypto-acompress=y" >> .config
        echo "CONFIG_PACKAGE_kmod-crypto-ccm=y" >> .config
        echo "CONFIG_PACKAGE_kmod-crypto-cmac=y" >> .config
        echo "CONFIG_PACKAGE_kmod-crypto-crc32c=y" >> .config
        echo "CONFIG_PACKAGE_kmod-crypto-ctr=y" >> .config
        echo "CONFIG_PACKAGE_kmod-crypto-des=y" >> .config
        echo "CONFIG_PACKAGE_kmod-crypto-gcm=y" >> .config
        echo "CONFIG_PACKAGE_kmod-crypto-gf128=y" >> .config
        echo "CONFIG_PACKAGE_kmod-crypto-ghash=y" >> .config
        echo "CONFIG_PACKAGE_kmod-crypto-hmac=y" >> .config
        echo "CONFIG_PACKAGE_kmod-crypto-md4=y" >> .config
        echo "CONFIG_PACKAGE_kmod-crypto-md5=y" >> .config
        echo "CONFIG_PACKAGE_kmod-crypto-rng=y" >> .config
        echo "CONFIG_PACKAGE_kmod-crypto-seqiv=y" >> .config
        echo "CONFIG_PACKAGE_kmod-crypto-sha256=y" >> .config
        echo "CONFIG_PACKAGE_kmod-crypto-sha512=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ebtables=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ebtables-ipv4=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ebtables-ipv6=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-autofs4=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-vfat=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ifb=y" >> .config
        echo "CONFIG_PACKAGE_kmod-inet-diag=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ip6tables-extra=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-compat-xtables=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-conntrack-extra=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-extra=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-filter=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-hashlimit=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-iface=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-ipmark=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-ipopt=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-iprange=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-ipv4options=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-nat-extra=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-offload=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-proto=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-raw6=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-tee=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-tproxy=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-u32=y" >> .config
        echo "CONFIG_PACKAGE_kmod-leds-ws2812b=y" >> .config
        echo "CONFIG_PACKAGE_kmod-lib-crc32c=y" >> .config
        echo "CONFIG_PACKAGE_kmod-lib-lzo=y" >> .config
        echo "CONFIG_PACKAGE_kmod-mediatek_hnat=y" >> .config
        echo "CONFIG_PACKAGE_kmod-mt_wifi=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nf-flow=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nls-base=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nls-cp437=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nls-iso8859-1=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nls-utf8=y" >> .config
        echo "CONFIG_PACKAGE_kmod-sched-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-scsi-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-tcp-bbr=y" >> .config
        echo "CONFIG_PACKAGE_kmod-tun=y" >> .config
        echo "CONFIG_PACKAGE_kmod-warp=y" >> .config
        echo "CONFIG_PACKAGE_kmod-zram=y" >> .config
        echo "CONFIG_PACKAGE_kvcedit=y" >> .config
        echo "CONFIG_PACKAGE_libatomic=y" >> .config
        echo "CONFIG_PACKAGE_libblkid=y" >> .config
        echo "CONFIG_PACKAGE_libcap-ng=y" >> .config
        echo "CONFIG_PACKAGE_libcbor=y" >> .config
        echo "CONFIG_PACKAGE_libevdev=y" >> .config
        echo "CONFIG_PACKAGE_libfido2=y" >> .config
        echo "CONFIG_PACKAGE_libipset=y" >> .config
        echo "CONFIG_PACKAGE_libkvcutil=y" >> .config
        echo "CONFIG_PACKAGE_libncurses=y" >> .config
        echo "CONFIG_PACKAGE_libnl=y" >> .config
        echo "CONFIG_PACKAGE_libnl-core=y" >> .config
        echo "CONFIG_PACKAGE_libnl-genl=y" >> .config
        echo "CONFIG_PACKAGE_libnl-nf=y" >> .config
        echo "CONFIG_PACKAGE_libnl-route=y" >> .config
        echo "CONFIG_PACKAGE_libopenssl-afalg_sync=y" >> .config
        echo "CONFIG_PACKAGE_libopenssl-devcrypto=y" >> .config
        echo "CONFIG_PACKAGE_libpcap=y" >> .config
        echo "CONFIG_PACKAGE_libstdcpp=y" >> .config
        echo "CONFIG_PACKAGE_libudev-zero=y" >> .config
        echo "CONFIG_PACKAGE_libuuid=y" >> .config
        echo "CONFIG_PACKAGE_lua-cjson=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-eqos-mtk=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-mtwifi-cfg=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-turboacc-mtk=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-eqos-mtk-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-mtwifi-cfg-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-turboacc-mtk-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-upnp-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-bootstrap-mod=y" >> .config
        echo "CONFIG_PACKAGE_mii_mgr=y" >> .config
        echo "CONFIG_PACKAGE_miniupnpd=y" >> .config
        echo "CONFIG_PACKAGE_mtkhqos_util=y" >> .config
        echo "CONFIG_PACKAGE_mtwifi-cfg=y" >> .config
        echo "CONFIG_PACKAGE_nano=y" >> .config
        echo "CONFIG_PACKAGE_openssh-keygen=y" >> .config
        echo "CONFIG_PACKAGE_openssh-sftp-server=y" >> .config
        echo "CONFIG_PACKAGE_openssl-util=y" >> .config
        echo "CONFIG_PACKAGE_regs=y" >> .config
        echo "CONFIG_PACKAGE_resolveip=y" >> .config
        echo "CONFIG_PACKAGE_swconfig=y" >> .config
        echo "CONFIG_PACKAGE_switch=y" >> .config
        echo "CONFIG_PACKAGE_tc-mod-iptables=y" >> .config
        echo "CONFIG_PACKAGE_tc-tiny=y" >> .config
        echo "CONFIG_PACKAGE_tcpdump=y" >> .config
        echo "CONFIG_PACKAGE_terminfo=y" >> .config
        echo "CONFIG_PACKAGE_wifi-dats=y" >> .config
        echo "CONFIG_PACKAGE_wireless-regdb=y" >> .config
        echo "CONFIG_PACKAGE_wireless-tools=y" >> .config
        echo "CONFIG_PACKAGE_zram-swap=y" >> .config
        echo "CONFIG_PKG_FORTIFY_SOURCE_2=y" >> .config
        echo "CONFIG_WARP_CHIPSET="mt7986"" >> .config
        echo "CONFIG_WARP_DBG_SUPPORT=y" >> .config
        echo "CONFIG_WARP_MEMORY_LEAK_DBG=y" >> .config
        echo "CONFIG_WARP_VERSION=2" >> .config
        echo "CONFIG_WED_HW_RRO_SUPPORT=y" >> .config
        echo "CONFIG_first_card=y" >> .config
        echo "CONFIG_first_card_name="MT7986"" >> .config

        
        # === 常用插件 ===
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-ttyd=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-autoreboot=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-ddns=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-filebrowser=y" >> .config
        
        # === VPN & KMS ===
        echo "CONFIG_PACKAGE_luci-app-vlmcsd=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-ipsec-vpnd=y" >> .config
        
        # === 科学上网 (Kenzo源) ===
        echo "CONFIG_PACKAGE_luci-app-passwall=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall_Iptables_Transparent_Proxy=y" >> .config
        # HomeProxy 在 Kernel 5.4 (21.02) 上可能存在兼容性问题，建议优先用 Passwall
        
        # 如果仓库里有 diy-part2.sh 就执行
        if [ -f $GITHUB_WORKSPACE/diy-part2.sh ]; then
          chmod +x $GITHUB_WORKSPACE/diy-part2.sh
          /bin/bash $GITHUB_WORKSPACE/diy-part2.sh
        fi
        
        # 生成完整配置
        make defconfig

    # 7. 下载依赖包
    - name: Download package
      id: package
      run: |
        cd openwrt
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    # 8. 编译固件
    - name: Compile the firmware
      id: compile
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        # 尝试多线程编译，失败则回退单线程并输出日志
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT
        
        # 提取设备名称和时间，用于重命名固件
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    # 9. 检查磁盘空间 (编译后)
    - name: Check space usage
      if: (!cancelled())
      run: df -hT

    # 10. 上传 bin 目录 (可选，包含所有 ipk 文件)
    # 如果不需要 ipk 文件，可以将 if 中的 true 改为 false
    # - name: Upload bin directory
      # uses: actions/upload-artifact@v4
      # if: steps.compile.outputs.status == 'success'
      # with:
        # name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        # path: openwrt/bin

    # 11. 整理固件文件 (只保留 img/bin 固件)
    - name: Organize files
      id: organize
      if: steps.compile.outputs.status == 'success'
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    # 12. 上传固件到 Artifacts (可在 Actions 页面下载)
    - name: Upload firmware directory
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success'
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    # 13. 生成 Release 标签
    - name: Generate release tag
      id: tag
      if: steps.compile.outputs.status == 'success'
      run: |
        echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        touch release.txt
        echo "Build success!" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    # 14. 发布到 Releases 页面
    - name: Upload firmware to release
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    # 15. 删除旧的工作流记录
    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        retain_days: 0
        keep_minimum_runs: 2

    # 16. 删除旧的 Releases
    - name: Remove old Releases
      uses: dev-drprasad/delete-older-releases@v0.3.3
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
