name: Build Xiaomi AX6000 OpenWrt 24.10 (Fix Path)

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: '是否开启 SSH'
        required: false
        default: 'false'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        echo "--- 系统空间检查 (清理前) ---"
        df -hT
        
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkg-config python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
        
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        # 修正1：不再创建 workdir，直接在当前环境操作
        
        echo "--- 系统空间检查 (清理后) ---"
        df -hT

    - name: Clone source code
      # 修正2：移除 working-directory，直接克隆到当前目录
      run: |
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        echo "Source code cloned. Current commit:"
        cd openwrt && git log -1

    - name: Load custom feeds
      run: |
        cd openwrt
        # 现在 cd openwrt 会成功，因为它就在根目录下
        echo "src-git kenzo https://github.com/kenzok8/small-package" >> feeds.conf.default
        echo "--- Feeds configuration ---"
        cat feeds.conf.default

    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "Feeds updated and installed."

    - name: Generate configuration file
      run: |
        cd openwrt
        
        # --- 写入配置 ---
        # 目标: MediaTek Filogic 830 (AX6000)
        echo "CONFIG_TARGET_mediatek=y" > .config
        echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
        echo "CONFIG_TARGET_mediatek_filogic_DEVICE_xiaomi_redmi-router-ax6000=y" >> .config
        
        # 基础包
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-ssl=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-ttyd=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-autoreboot=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-ddns=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-filebrowser=y" >> .config
        
        # VPN & KMS
        echo "CONFIG_PACKAGE_luci-app-ipsec-vpnd=y" >> .config
        echo "CONFIG_PACKAGE_strongswan-default=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-vlmcsd=y" >> .config
        
        # 科学上网
        echo "CONFIG_PACKAGE_luci-app-passwall=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall_Iptables_Transparent_Proxy=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-homeproxy=y" >> .config
        
        # 工具
        echo "CONFIG_PACKAGE_curl=y" >> .config
        echo "CONFIG_PACKAGE_htop=y" >> .config
        
        # 生成完整配置
        make defconfig
        
        echo "--- 检查生成的 .config (前200行) ---"
        cat .config | head -n 200
        echo "..."

    - name: Download package
      run: |
        cd openwrt
        echo "Downloading packages..."
        make download -j8
        
        echo "Checking for download failures..."
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Compile the firmware
      id: compile
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        
        make -j$(nproc) || make -j1 || make -j1 V=s
        
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload debug info on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: failure-debug-info
        path: |
          openwrt/.config
          openwrt/feeds.conf.default
          openwrt/tmp/
    
    - name: Organize files
      id: organize
      if: steps.compile.outputs.status == 'success'
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware directory
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success'
      with:
        name: OpenWrt_firmware${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        retain_days: 1
        keep_minimum_runs: 3
