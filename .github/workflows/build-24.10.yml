name: Build Xiaomi AX6000 OpenWrt 24.10 (Disk Monitor)

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: '是否开启 SSH (用于调试)'
        required: false
        default: 'false'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # 1. 检出代码
    - name: Checkout (检出代码)
      uses: actions/checkout@v4

    # 2. 深度清理磁盘空间 (关键步骤)
    # OpenWrt 24.10 + Rust (Sing-box) 编译非常消耗空间，必须先清理
    - name: Free Disk Space (深度清理磁盘)
      run: |
        echo "=== [清理前] 磁盘空间状态 ==="
        df -hT
        
        echo "正在移除 Docker 镜像..."
        docker rmi `docker images -q`
        
        echo "正在移除预装的大型软件包 (Android SDK, DotNet, CodeQL)..."
        sudo rm -rf \
          /usr/share/dotnet \
          /usr/local/lib/android \
          /opt/ghc \
          /opt/hostedtoolcache/CodeQL \
          /usr/share/swift \
          /usr/local/.ghcup \
          /usr/lib/jvm \
          /usr/local/share/powershell \
          /usr/local/lib/node_modules
          
        echo "正在清理 APT 缓存..."
        sudo -E apt-get -q purge azure-cli ghc* zulu* hhvm llvm* firefox google-chrome-stable microsoft-edge-stable dotnet* powershell openjdk* mysql* php* mongodb* moby* snapd* || true
        sudo -E apt-get -y autoremove --purge
        sudo -E apt-get clean
        
        echo "=== [清理后] 磁盘空间状态 ==="
        df -hT

    # 3. 初始化编译环境
    - name: Initialization environment (初始化环境)
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkg-config python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
        
        sudo timedatectl set-timezone "$TZ"
        
        echo "=== [环境安装后] 磁盘空间状态 ==="
        df -hT

    # 4. 克隆源码
    - name: Clone source code (克隆源码)
      run: |
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        echo "Source code cloned. Current commit:"
        cd openwrt && git log -1
        
        echo "=== [源码克隆后] 磁盘空间状态 ==="
        df -hT

    # 5. 加载自定义源 (Feeds)
    - name: Load custom feeds (加载插件源)
      run: |
        cd openwrt
        # 添加最新 mt76驱动 feed 到 feeds.conf.default（如果已存在，会追加）
        echo "src-git mt76 https://github.com/openwrt/mt76.git^master" >> feeds.conf.default
        # 号称最全的软件包源
        echo "src-git kenzo https://github.com/kenzok8/small-package" >> feeds.conf.default
        # 跟openclash类似的软件源Nikki
        echo "src-git nikki https://github.com/nikkinikki-org/OpenWrt-nikki.git;main" >> "feeds.conf.default"
        echo "--- Feeds configuration ---"
        cat feeds.conf.default

    # 6. 更新并安装插件
    - name: Update feeds (更新并安装插件)
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "Feeds updated and installed."
        
        echo "=== [插件安装后] 磁盘空间状态 ==="
        df -hT

    # 7. 生成配置文件
    - name: Generate configuration file (生成 .config)
      run: |
        cd openwrt
        
        # --- 写入配置 ---
        # 目标: MediaTek Filogic 830 (AX6000)
        echo "CONFIG_TARGET_mediatek=y" > .config
        echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
        echo "CONFIG_TARGET_mediatek_filogic_DEVICE_xiaomi_redmi-router-ax6000=y" >> .config
        echo "CONFIG_TARGET_mediatek_filogic_DEVICE_xiaomi_redmi-router-ax6000-stock=y" >> .config
        # 基础包
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-ssl=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-ttyd=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-autoreboot=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-ddns=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
        # echo "CONFIG_PACKAGE_luci-app-filebrowser=y" >> .config
        
        # VPN & KMS
        echo "CONFIG_PACKAGE_luci-app-ipsec-vpnd=y" >> .config
        echo "CONFIG_PACKAGE_strongswan-default=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-vlmcsd=y" >> .config
        
        # 科学上网 (注意：HomeProxy 依赖 Rust，极度消耗空间)现在弃用passwall，改用openclash或者nikki
        # echo "CONFIG_PACKAGE_luci-app-passwall=y" >> .config
        # echo "CONFIG_PACKAGE_luci-app-passwall_Iptables_Transparent_Proxy=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-nikki=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        
        # 工具
        echo "CONFIG_PACKAGE_curl=y" >> .config
        echo "CONFIG_PACKAGE_htop=y" >> .config
        
        # 生成完整配置
        make defconfig
        
        echo "--- 检查生成的 .config (前200行) ---"
        cat .config | head -n 200
        
        echo "=== [配置生成后] 磁盘空间状态 ==="
        df -hT

    # 8. 下载源代码包
    - name: Download package (下载依赖包)
      run: |
        cd openwrt
        echo "Downloading packages..."
        make download -j8
        
        echo "Checking for download failures..."
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
        
        echo "=== [下载完成后] 磁盘空间状态 ==="
        df -hT
    - name: Create and customize wireless config file  # 创建并自定义 wireless 文件，默认开启 WiFi 并应用 mt76 优化
      run: |
        # 进入源码目录（如果不在其中）
        # cd openwrt
    
        # 创建目录（如果不存在）
        mkdir -p package/base-files/files/etc/config
    
        # 创建 wireless 文件并写入优化配置（基于最新 mt76 驱动）
        cat << EOF > package/base-files/files/etc/config/wireless
        config wifi-device 'radio0'  # 2.4GHz 接口（开源 mt76 驱动）
            option type 'mac80211'   # 开源驱动类型
            option path '1e140000.pcie/pci0000:00/0000:00:00.0/0000:01:00.0'  # AX6000 的 2.4GHz 路径（从 dts 确认）
            option band '2.4g'
            option channel 'auto'    # 自动频道，或固定如 '6' 避免干扰
            option htmode 'HE40'     # HE40/HE20 优化 WiFi 6 吞吐（HE20 更稳定）
            option txpower '20'      # 传输功率（dBm），默认 20-23，根据法规调整
            option country 'CN'      # 国家码，替换为您所在地区（避免 DFS 问题）
            option disabled '0'      # 0 = 默认开启
            option noscan '1'        # 禁用扫描，提升启动速度
            option cell_density '0'  # 单元密度 0（禁用），优化高密度环境

        config wifi-iface 'default_radio0'
            option device 'radio0'
            option network 'lan'
            option mode 'ap'
            option ssid 'RockyDokey'  # 默认 SSID，可自定义
            option encryption 'psk2+ccmp'  # WPA2+AES，提升安全
            option key ''  # 默认密码，可自定义
            option ieee80211r '1'    # 启用快速漫游（802.11r）
            option mobility_domain '4F57'  # 自定义域
            option ft_over_ds '1'    # FT over DS 支持
            option ft_psk_generate_local '1'  # 本地生成 PSK

        config wifi-device 'radio1'  # 5GHz 接口
            option type 'mac80211'
            option path '1e140000.pcie/pci0000:00/0000:00:01.0/0000:02:00.0'  # AX6000 的 5GHz 路径
            option band '5g'
            option channel 'auto'    # 自动频道，或固定如 '36'（低频道避免干扰）
            option htmode 'HE80'     # HE80/HE160 优化高吞吐（HE40 更兼容）
            option txpower '23'      # 更高功率，提升信号（合规检查）
            option country 'CN'
            option disabled '0'      # 默认开启
            option noscan '1'
            option cell_density '0'

        config wifi-iface 'default_radio1'
            option device 'radio1'
            option network 'lan'
            option mode 'ap'
            option ssid 'RockyDokey_5G'
            option encryption 'psk2+ccmp'
            option key ''
            option ieee80211r '1'
            option mobility_domain '4F57'
            option ft_over_ds '1'
            option ft_psk_generate_local '1'
        EOF

        # 确保权限正确
        chmod 644 package/base-files/files/etc/config/wireless
    # 9. 编译固件
    - name: Compile the firmware (开始编译)
      id: compile
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        
        echo "=== [编译开始前] 磁盘空间状态 ==="
        df -hT
        
        # 编译命令
        make -j$(nproc) || make -j1 || make -j1 V=s
        
        echo "status=success" >> $GITHUB_OUTPUT
        
        echo "=== [编译完成后] 磁盘空间状态 ==="
        df -hT

    # 10. 失败时上传调试信息
    - name: Upload debug info on failure (失败时上传日志)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: failure-debug-info
        path: |
          openwrt/.config
          openwrt/feeds.conf.default
          openwrt/tmp/

    # 11. 整理编译产物
    - name: Organize files (整理固件)
      id: organize
      if: steps.compile.outputs.status == 'success'
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    # 12. 上传固件
    - name: Upload firmware directory (上传固件)
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success'
      with:
        name: OpenWrt_firmware${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    # 13. 删除旧记录
    - name: Delete workflow runs (删除旧记录)
      uses: Mattraks/delete-workflow-runs@v2
      with:
        retain_days: 1
        keep_minimum_runs: 3
